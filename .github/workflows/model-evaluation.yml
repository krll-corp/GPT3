name: Model Evaluation

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * 1'

jobs:
  evaluate:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        model:
          - k050506koch/GPT3-dev
          - k050506koch/GPT3-dev-125m
          - k050506koch/GPT3-dev-125m-0612
          - k050506koch/GPT3-dev-125m-1202
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --index-url https://download.pytorch.org/whl/cpu torch
          pip install transformers datasets tqdm numpy

      - name: Run evaluation
        env:
          TOKENIZERS_PARALLELISM: 'false'
        run: |
          python eval.py \
            --model "${{ matrix.model }}" \
            --run-hellaswag \
            --run-lambada \
            --run-mmlu \
            --mmlu-tasks abstract_algebra \
            --batch-size 2 \
            --block-size 128
